<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cubemail — Inbox</title>
  <link rel="icon" href="/mnt/data/59f10601-2032-4792-8be0-c9c6a8b85397.png" />
  <style>
    /* Modern clean inbox UI */
    :root{
      --bg:#f6f9ff;
      --card:#ffffff;
      --accent:#2563eb;
      --accent-2:#0b845f;
      --muted:#6b7280;
      --radius:12px;
      --shadow: 0 12px 35px rgba(12,15,30,0.06);
      --max-width:1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:#111}
    .wrap{max-width:var(--max-width);margin:28px auto;padding:18px}
    header.appbar{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#fff;font-weight:800;font-size:18px}
    .brand h1{margin:0;font-size:20px}
    .user-info{font-size:14px;color:var(--muted)}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:20px}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .sidebar .section-title{font-weight:700;margin:0 0 8px}
    .compose{display:flex;flex-direction:column;gap:8px}
    .input, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e9f0ff;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:8px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--accent)}

    /* Inbox list */
    .inbox-list{display:flex;flex-direction:column;gap:8px;max-height:560px;overflow:auto;padding-right:6px}
    .msg{display:flex;gap:12px;padding:10px;border-radius:10px;border:1px solid #f1f6ff;background:linear-gradient(180deg,#fff,#ffffff);align-items:flex-start}
    .msg .meta{font-size:12px;color:var(--muted)}
    .msg .body{font-size:14px;color:#111}
    .msg .avatar{width:40px;height:40px;border-radius:8px;display:grid;place-items:center;background:#eef6ff;color:var(--accent);font-weight:700}

    .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .small{font-size:13px;color:var(--muted)}

    pre.profile-json{background:#fbfdff;padding:12px;border-radius:8px;overflow:auto;font-size:13px}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;gap:12px}
      .inbox-list{max-height:360px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="appbar">
      <div class="brand" aria-hidden>
        <div class="logo">C</div>
        <div>
          <h1>Cubemail</h1>
          <div class="user-info" id="userSubtitle">Loading...</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button id="refreshBtn" class="btn ghost" title="Refresh">Refresh</button>
        <button id="logoutBtn" class="btn" style="background:#ff5b5b;color:#fff">Logout</button>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Compose + quick links -->
      <aside class="panel sidebar" aria-label="Composer and folders">
        <h3 class="section-title">Compose</h3>
        <div class="compose">
          <input id="toInput" class="input" placeholder="To (cubemail@example.com)">
          <input id="subjectInput" class="input" placeholder="Subject">
          <textarea id="bodyInput" placeholder="Write a message..."></textarea>
          <div style="display:flex;gap:8px">
            <button id="sendBtn" class="btn primary">Send</button>
            <button id="clearBtn" class="btn ghost">Clear</button>
          </div>
          <div id="composeStatus" class="small" style="margin-top:8px"></div>
        </div>

        <hr style="margin:14px 0;border:0;border-top:1px solid #f1f6ff">

        <h4 style="margin:0 0 8px">Quick actions</h4>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="inboxBtn" class="btn ghost">Inbox</button>
          <button id="sentBtn" class="btn ghost">Sent</button>
        </div>

        <hr style="margin:14px 0;border:0;border-top:1px solid #f1f6ff">
        <h4 style="margin:0 0 8px">Profile</h4>
        <div id="profileMini" class="small">loading...</div>
      </aside>

      <!-- RIGHT: Inbox messages -->
      <section class="panel" aria-label="Messages">
        <div class="toolbar">
          <h3 style="margin:0">Inbox</h3>
          <div style="flex:1"></div>
          <div class="small" id="messagesCount">—</div>
        </div>

        <div id="inboxList" class="inbox-list" role="list" aria-label="Message list">
          <!-- messages appended here -->
        </div>

        <div style="margin-top:14px">
          <h4 style="margin:0 0 8px">Raw profile</h4>
          <pre id="profileRaw" class="profile-json">loading...</pre>
        </div>
      </section>
    </div>
  </div>

  <!-- Supabase SDK + shared client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
  <script src="supabaseClient.js"></script>

  <script>
    // inbox.html script — uses window.supabaseClient (supabaseClient.js must be loaded)
    (function () {
      const sb = window.supabaseClient;
      if (!sb) {
        alert('Supabase client not initialized. Check supabaseClient.js');
        return;
      }

      // DOM elements
      const userSubtitle = document.getElementById('userSubtitle');
      const profileMini = document.getElementById('profileMini');
      const profileRaw = document.getElementById('profileRaw');
      const inboxList = document.getElementById('inboxList');
      const messagesCount = document.getElementById('messagesCount');

      const toInput = document.getElementById('toInput');
      const subjectInput = document.getElementById('subjectInput');
      const bodyInput = document.getElementById('bodyInput');
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      // state
      let profile = null;
      let messages = [];

      // helpers
      function fmtTime(ts) {
        try {
          return new Date(ts).toLocaleString();
        } catch (e) { return ts; }
      }

      function renderProfile(p) {
        profileMini.innerText = p ? (p.cubemail || p.email || 'Unknown') : 'not found';
        profileRaw.textContent = p ? JSON.stringify(p, null, 2) : 'no profile data';
        userSubtitle.innerText = p ? ('Signed in as ' + (p.cubemail || p.email)) : 'Not signed in';
      }

      function renderMessages(list) {
        inboxList.innerHTML = '';
        if (!list || list.length === 0) {
          inboxList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">No messages yet.</div>';
          messagesCount.innerText = '0';
          return;
        }
        messagesCount.innerText = String(list.length);
        list.forEach(msg => {
          const node = document.createElement('div');
          node.className = 'msg';
          node.role = 'listitem';
          const initials = (msg.from_cubemail || msg.from_email || 'U').charAt(0).toUpperCase();
          node.innerHTML = `
            <div class="avatar" style="min-width:40px">
              <div class="avatar-inner" style="width:40px;height:40px;border-radius:8px;background:#eef6ff;color:var(--accent);display:grid;place-items:center;font-weight:700">${initials}</div>
            </div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:700">${msg.subject || '(no subject)'}</div>
                  <div class="meta">${msg.from_cubemail || msg.from_email || 'Unknown sender'} · <span style="color:var(--muted)">${fmtTime(msg.created_at)}</span></div>
                </div>
              </div>
              <div class="body" style="margin-top:8px">${(msg.content || '').replace(/\n/g,'<br>')}</div>
            </div>
          `;
          inboxList.appendChild(node);
        });
      }

      // load current session & profile
      async function loadProfileAndMessages() {
        try {
          const { data: sessionData } = await sb.auth.getSession();
          const session = sessionData?.session;
          if (!session) {
            // not logged in
            window.location.href = 'login.html';
            return;
          }
          const user = session.user;
          // fetch profile from profiles table
          const { data: p, error: pErr } = await sb.from('profiles').select('*').eq('id', user.id).single();
          if (pErr) {
            console.warn('Unable to load profile:', pErr.message);
            profile = { email: user.email };
          } else profile = p;
          renderProfile(profile);
          // now load messages for this user (inbox)
          await loadMessages();
        } catch (err) {
          console.error('loadProfileAndMessages', err);
          profileMini.innerText = 'Failed to load profile';
        }
      }

      // load messages (simple inbox: messages where to_cubemail = profile.cubemail)
      async function loadMessages() {
        try {
          if (!profile) return;
          // try to read messages by cubemail first
          const target = profile.cubemail || profile.email;
          if (!target) {
            renderMessages([]);
            return;
          }
          // expected schema: messages table with columns:
          // id (uuid), from_id, from_email, from_cubemail, to_cubemail, subject, content, created_at
          const { data: msgs, error } = await sb
            .from('messages')
            .select('id,from_id,from_email,from_cubemail,to_cubemail,subject,content,created_at')
            .eq('to_cubemail', target)
            .order('created_at', { ascending: false })
            .limit(200);
          if (error) {
            console.warn('Could not fetch messages:', error.message);
            renderMessages([]);
            return;
          }
          messages = msgs || [];
          renderMessages(messages);
        } catch (err) {
          console.error('loadMessages', err);
          renderMessages([]);
        }
      }

      // send message (inserts into messages table)
      async function sendMessage() {
        composeStatus('Sending...');
        const toAddr = toInput.value.trim();
        const subject = subjectInput.value.trim();
        const content = bodyInput.value.trim();
        if (!toAddr || !content) {
          composeStatus('Please provide a recipient and message body.');
          return;
        }
        try {
          // get current user
          const { data: s } = await sb.auth.getSession();
          const user = s?.session?.user;
          const payload = {
            from_id: user?.id || null,
            from_email: user?.email || null,
            from_cubemail: profile?.cubemail || profile?.email || null,
            to_cubemail: toAddr,
            subject,
            content
          };
          const { error } = await sb.from('messages').insert(payload);
          if (error) {
            composeStatus('Send failed: ' + error.message);
            return;
          }
          // success - clear and refresh inbox
          toInput.value = '';
          subjectInput.value = '';
          bodyInput.value = '';
          composeStatus('Message sent.');
          await loadMessages();
        } catch (err) {
          console.error('sendMessage', err);
          composeStatus('Send failed — check console.');
        }
      }

      function composeStatus(text) {
        const el = document.getElementById('composeStatus');
        if (el) el.innerText = text;
      }

      // wire UI
      sendBtn.addEventListener('click', sendMessage);
      clearBtn.addEventListener('click', () => { toInput.value = ''; subjectInput.value = ''; bodyInput.value = ''; composeStatus(''); });
      refreshBtn.addEventListener('click', loadMessages);
      inboxBtn.addEventListener('click', loadMessages);
      sentBtn?.addEventListener('click', async () => {
        // show messages sent by this user
        if (!profile) return;
        const fromVal = profile.cubemail || profile.email;
        try {
          const { data: sent, error } = await sb.from('messages').select('*').eq('from_cubemail', fromVal).order('created_at', { ascending: false }).limit(200);
          if (error) { console.warn(error); renderMessages([]); return; }
          renderMessages(sent || []);
        } catch (err) { console.error(err); renderMessages([]); }
      });

      logoutBtn.addEventListener('click', async () => {
        await sb.auth.signOut();
        window.location.href = 'login.html';
      });

      // initial load
      loadProfileAndMessages();

      // OPTIONAL: subscribe to realtime updates (if you have DB replication/Realtime enabled)
      // This block tries to set up a realtime listener if possible; it will silently fail if not enabled.
      try {
        if (sb && sb.channel) {
          const channel = sb.channel('messages:inbox').on(
            'postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'messages' },
            payload => {
              // reload messages when new one arrives
              // small optimization: only reload if it targets this user
              const newMsg = payload?.new;
              const target = profile?.cubemail || profile?.email;
              if (newMsg && target && newMsg.to_cubemail === target) {
                // prepend to messages
                messages = [newMsg, ...messages];
                renderMessages(messages);
              }
            }
          );
          channel.subscribe();
        }
      } catch (e) {
        // not fatal
        console.debug('Realtime subscription not available or failed:', e?.message || e);
      }
    })();
  </script>
</body>
</html>
